@page "/"
@page "/elevatorproblem"
@inject IJSRuntime JsRuntime;

<div class="row mb-3">
    <div class="col-12">
        @if (Simulating)
        {
            <div class="alert alert-warning mb-2">
                <strong>Simulation Running</strong>
                <div class="progress mt-2" style="height: 8px;">
                    <div class="progress-bar progress-bar-striped bg-warning progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        }
        else
        {
            <div class="alert alert-info mb-2">
                <strong>Simulation Paused</strong>
            </div>
        }
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Passengers</small>
                <h5 class="mb-0">@Passengers.Count</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Time Passed</small>
                <h5 class="mb-0">@TotalTimePassed</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Total Wait Time</small>
                <h5 class="mb-0">@Passengers.Sum(i => i.WaitTime)</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Power Consumed</small>
                <h5 class="mb-0">@PowerConsumed</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Avg Wait Time</small>
                <h5 class="mb-0">@Math.Round(Passengers.Count != 0 ? ((double)Passengers.Sum(i => i.WaitTime) / Passengers.Count) : 0, 2)</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4 col-sm-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted">Avg Power/Time</small>
                <h5 class="mb-0">@Math.Round(TotalTimePassed != 0 ? ((double)PowerConsumed / TotalTimePassed) : 0, 2)</h5>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6 mb-2">
        <NewPassengerProbabilityCard @bind-Probability="NewPassengerProbability"
                                     @bind-Probability:event="ProbabilityChanged" />
    </div>
    <div class="col-md-6 mb-2">
        <div class="card">
            <div class="card-body">
                <small class="text-muted d-block mb-2">Speed</small>
                <div class="btn-group" role="group">
                    <button type="button" class="btn @(NormalSpeed ? "btn-primary" : "btn-outline-secondary")" @onclick="ToggleSpeed">Normal</button>
                    <button type="button" class="btn @(!NormalSpeed ? "btn-danger" : "btn-outline-secondary")" @onclick="ToggleSpeed">Fast</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <button class="btn btn-primary btn-sm" @onclick="AddElevator">
        <span class="oi oi-plus"></span> Add Elevator
    </button>
    <button class="btn btn-secondary btn-sm" @onclick="AddFloor">
        <span class="oi oi-plus"></span> Add Floor
    </button>
    @if (Floors.Count > 1)
    {
        <button class="btn btn-secondary btn-sm" @onclick="RemoveFloor">
            <span class="oi oi-minus"></span> Remove Floor
        </button>
    }
    @if (Simulating)
    {
        <button type="button" class="btn btn-warning btn-sm" @onclick="SimulateToggle">
            <span class="oi oi-media-pause"></span> Stop
        </button>
    }
    else
    {
        <button type="button" class="btn btn-success btn-sm" @onclick="SimulateToggle">
            <span class="oi oi-media-play"></span> Start
        </button>
    }
</div>

<div class="card bg-success text-white mb-3">
    <div class="card-header py-2">
        <strong>Fulfilled Passengers (@Passengers.Count(i => i.CurrentFloor == i.RequestedFloor))</strong>
    </div>
    <div class="card-body p-2">
        <div class="row">
            @foreach (PassengerModel passenger in Passengers.Where(i => i.CurrentFloor == i.RequestedFloor))
            {
                <div class="col-auto mb-2">
                    <Passenger PassengerModel="passenger" />
                </div>
            }
        </div>
    </div>
</div>

@foreach (FloorModel floor in Floors.OrderByDescending(i => i.Id))
{
    <Floor FloorModel="floor"
           Elevators="Elevators.Where(i => i.CurrentFloor == floor).ToList()"
           Passengers="Passengers.Where(i => i.CurrentFloor == floor && i.CurrentFloor != i.RequestedFloor).ToList()"
           DeleteElevator="DeleteElevator" />
}

@code {
    List<FloorModel> Floors = new List<FloorModel>();
    List<ElevatorModel> Elevators = new List<ElevatorModel>();
    List<PassengerModel> Passengers = new List<PassengerModel>();

    int NewPassengerProbability { get; set; } = 50;

    Random random = new Random((int)DateTime.Now.Ticks);
    int TotalTimePassed = 0;
    int PowerConsumed = 0;
    bool Simulating = false;
    bool NormalSpeed = true;

    protected override void OnInitialized()
    {
        // Initialize with ten Floor
        Enumerable.Range(0, 10).ToList().ForEach(_ => AddFloor());

        // Initialize with three Elevator
        Enumerable.Range(0, 3).ToList().ForEach(_ => AddElevator());
    }

    async void SimulateToggle()
    {
        Simulating = !Simulating;

        StateHasChanged();

        if (Simulating)
        {
            await RunSimulation();
        }
    }

    private void ToggleSpeed()
    {
        NormalSpeed = !NormalSpeed;

        StateHasChanged();
    }

    public async Task RunSimulation()
    {
        while (Simulating)
        {
            SimulateAddPassenger();

            SimulatePassengersEnter();

            SimulatePassengersExit();

            SimulateMoveElevators();

            // Increment Passenger Wait Time
            Passengers.Where(i => i.CurrentFloor != i.RequestedFloor).ToList().ForEach(i => i.IncrementWaitTime());

            TotalTimePassed++;

            StateHasChanged();

            // Wait 1 second (normal speed)
            await Task.Delay(NormalSpeed ? 1000 : 100);
        }
    }

    void SimulateMoveElevators()
    {
        // For Each Floor that has waiting passengers
        foreach (FloorModel floorModel in Floors)
        {
            if (Passengers.Where(i => i.CurrentFloor != i.RequestedFloor && i.CurrentFloor == floorModel && i.CurrentElevator == null).Any())
            {
                // Search for an elevator that is moving torwards it
                if (Elevators.Where(
                    i => (i.CurrentDirection == CurrentDirection.Down && i.CurrentFloor.Id > floorModel.Id)
                    || (i.CurrentDirection == CurrentDirection.Up && i.CurrentFloor.Id < floorModel.Id)).Any())
                {
                    continue;
                }

                // Send for an elevator that is closest waiting
                FloorModel floorAbove = floorModel;
                FloorModel floorBelow = floorModel;
                ElevatorModel elevatorModel = null;
                do
                {
                    if (floorAbove != null)
                        floorAbove = Floors.Where(i => i.Id == floorAbove.Id + 1).FirstOrDefault();
                    if (floorBelow != null)
                        floorBelow = Floors.Where(i => i.Id == floorBelow.Id - 1).FirstOrDefault();

                    if (floorAbove != null)
                    {
                        elevatorModel = Elevators.Where(
                            i => i.CurrentFloor == floorAbove && i.CurrentDirection == CurrentDirection.Wait).FirstOrDefault();

                        if (elevatorModel != null)
                        {
                            elevatorModel.CurrentDirection = CurrentDirection.Down;
                            continue;
                        }
                    }
                    if (floorBelow != null)
                    {
                        elevatorModel = Elevators.Where(
                            i => i.CurrentFloor == floorBelow && i.CurrentDirection == CurrentDirection.Wait).FirstOrDefault();

                        if (elevatorModel != null)
                        {
                            elevatorModel.CurrentDirection = CurrentDirection.Up;
                            continue;
                        }
                    }
                } while ((floorAbove != null || floorBelow != null) && elevatorModel == null);
            }
        }

        foreach (ElevatorModel elevatorModel in Elevators)
        {
            CurrentDirection currentDirection = elevatorModel.CurrentDirection;

            switch (currentDirection)
            {
                case CurrentDirection.Wait:
                    break;
                case CurrentDirection.Up:
                    elevatorModel.CurrentFloor = Floors.Where(i => i.Id == elevatorModel.CurrentFloor.Id + 1).First();
                    Passengers.Where(i => i.CurrentElevator == elevatorModel).ToList().ForEach(i => i.CurrentFloor = elevatorModel.CurrentFloor);
                    PowerConsumed++;
                    break;
                case CurrentDirection.Down:
                    elevatorModel.CurrentFloor = Floors.Where(i => i.Id == elevatorModel.CurrentFloor.Id - 1).First();
                    Passengers.Where(i => i.CurrentElevator == elevatorModel).ToList().ForEach(i => i.CurrentFloor = elevatorModel.CurrentFloor);
                    PowerConsumed++;
                    break;
            }
        }
    }

    void SimulateAddPassenger()
    {
        if (NewPassengerProbability > random.Next(0, 99))
        {
            AddPassenger();
        }
    }

    void SimulatePassengersEnter()
    {
        foreach (ElevatorModel elevatorModel in Elevators)
        {
            CurrentDirection currentDirection = elevatorModel.CurrentDirection;

            if (currentDirection == CurrentDirection.Wait)
            {
                PassengerModel passengerModel = Passengers.Where(
                    i => i.CurrentFloor != i.RequestedFloor
                    && i.CurrentElevator == null
                    && i.CurrentFloor == elevatorModel.CurrentFloor).FirstOrDefault();
                if (passengerModel != null)
                    currentDirection
                        = elevatorModel.CurrentDirection
                        = (passengerModel.RequestedFloor.Id > elevatorModel.CurrentFloor.Id
                        ? CurrentDirection.Up : CurrentDirection.Down);
            }

            switch (currentDirection)
            {
                case CurrentDirection.Wait:
                    break;
                case CurrentDirection.Up:
                    Passengers.Where(i => i.CurrentFloor != i.RequestedFloor
                        && i.CurrentFloor == elevatorModel.CurrentFloor
                        && i.CurrentElevator == null
                        && i.RequestedFloor.Id > i.CurrentFloor.Id).ToList()
                        .ForEach(i => i.EnterElevator(elevatorModel));
                    break;
                case CurrentDirection.Down:
                    Passengers.Where(i => i.CurrentFloor != i.RequestedFloor
                        && i.CurrentFloor == elevatorModel.CurrentFloor
                        && i.CurrentElevator == null
                        && i.RequestedFloor.Id < i.CurrentFloor.Id).ToList()
                        .ForEach(i => i.EnterElevator(elevatorModel));
                    break;
            }
        }
    }

    void SimulatePassengersExit()
    {
        Passengers.Where(i => i.CurrentElevator != null && i.CurrentFloor == i.RequestedFloor).ToList().ForEach(i => i.CurrentElevator = null);

        foreach (ElevatorModel elevatorModel in Elevators.Where(i => i.CurrentDirection != CurrentDirection.Wait))
            if (!Passengers.Where(i => i.CurrentElevator == elevatorModel).Any())
                elevatorModel.CurrentDirection = CurrentDirection.Wait;
    }

    void AddElevator()
    {
        var elevator = new ElevatorModel()
        {
            Id = Elevators.Count,
            CurrentFloor = Floors.First()
        };

        Elevators.Add(elevator);

        StateHasChanged();
    }

    void AddFloor()
    {
        var floor = new FloorModel()
        {
            Id = Floors.Count + 1
        };

        Floors.Add(floor);

        StateHasChanged();
    }

    void AddPassenger()
    {
        // Case when there is only one floor
        if (Floors.Count == 1) return;

        int randomInt = random.Next(1, Floors.Count + 1);
        int randomIntNew = random.Next(1, Floors.Count + 1);
        FloorModel randomCurrentFloor = Floors.Where(i => i.Id == randomInt).First();
        while (randomInt == randomIntNew)
        {
            randomIntNew = random.Next(1, Floors.Count + 1);
        }
        FloorModel randomRequestedFloor = Floors.Where(i => i.Id == randomIntNew).First();

        var passenger = new PassengerModel()
        {
            Id = Passengers.Count,
            CurrentFloor = randomCurrentFloor,
            RequestedFloor = randomRequestedFloor
        };

        Passengers.Add(passenger);

        StateHasChanged();
    }

    void RemoveFloor()
    {
        Floors.RemoveAt(Floors.Count - 1);

        StateHasChanged();
    }

    public async Task DeleteElevator(ElevatorModel elevator)
    {
        Elevators.Remove(elevator);

        StateHasChanged();
    }
}

